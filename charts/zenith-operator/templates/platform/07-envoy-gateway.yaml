{{- if and .Values.installStack .Values.envoyGateway.enabled }}
---
apiVersion: v1
kind: Namespace
metadata:
  name: envoy-gateway-system
  labels:
    app.kubernetes.io/name: envoy-gateway
    app.kubernetes.io/instance: {{ .Release.Name }}
    app.kubernetes.io/managed-by: {{ .Release.Service }}
---
# 
# 
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: envoy-gateway-installer
  namespace: envoy-gateway-system
  annotations:
    "helm.sh/hook": post-install,post-upgrade
    "helm.sh/hook-weight": "5"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: envoy-gateway-installer
  annotations:
    "helm.sh/hook": post-install,post-upgrade
    "helm.sh/hook-weight": "5"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
rules:
- apiGroups: ["*"]
  resources: ["*"]
  verbs: ["*"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: envoy-gateway-installer
  annotations:
    "helm.sh/hook": post-install,post-upgrade
    "helm.sh/hook-weight": "5"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: envoy-gateway-installer
subjects:
- kind: ServiceAccount
  name: envoy-gateway-installer
  namespace: envoy-gateway-system
---
apiVersion: batch/v1
kind: Job
metadata:
  name: envoy-gateway-installer-{{ .Release.Revision }}
  namespace: envoy-gateway-system
  annotations:
    "helm.sh/hook": post-install,post-upgrade
    "helm.sh/hook-weight": "6"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
  labels:
    app.kubernetes.io/name: envoy-gateway-installer
    app.kubernetes.io/instance: {{ .Release.Name }}
    app.kubernetes.io/managed-by: {{ .Release.Service }}
spec:
  ttlSecondsAfterFinished: 300
  template:
    metadata:
      labels:
        app.kubernetes.io/name: envoy-gateway-installer
    spec:
      serviceAccountName: envoy-gateway-installer
      restartPolicy: OnFailure
      containers:
      - name: installer
        image: bitnami/kubectl:latest
        command:
        - /bin/bash
        - -c
        - |
          set -e
          
          echo "Installing Envoy Gateway {{ .Values.envoyGateway.version }}..."
          
          curl -sL https://github.com/envoyproxy/gateway/releases/download/{{ .Values.envoyGateway.version }}/install.yaml > /tmp/envoy-gateway-install.yaml
          
          cd /tmp
          csplit -s -f envoy-gateway- envoy-gateway-install.yaml '/^---$/' '{*}'
          
          for file in envoy-gateway-*; do
            if ! grep -q "kind: CustomResourceDefinition" "$file"; then
              kubectl apply -f "$file" 2>&1 | grep -v "unchanged" || true
            fi
          done
          
          echo "✓ Envoy Gateway installed"
          
          echo "Waiting for Envoy Gateway to be ready..."
          kubectl wait --for=condition=available --timeout=60s deployment/envoy-gateway -n envoy-gateway-system || true
          
          echo "✓ Envoy Gateway is ready"
{{- end }}
