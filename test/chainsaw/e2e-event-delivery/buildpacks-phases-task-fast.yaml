apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: buildpacks-phases
spec:
  params:
    - name: APP_IMAGE
      type: string
    - name: SOURCE_SUBPATH
      type: string
      default: ""
    - name: CNB_BUILDER_IMAGE
      type: string
      default: "paketobuildpacks/builder-jammy-base:latest"
    - name: CNB_PROCESS_TYPE
      type: string
      default: ""
  workspaces:
    - name: source
  results:
    - name: APP_IMAGE_DIGEST
      description: Digest of the image (fast-path for testing operator behavior)
  steps:
    - name: fast-build
      image: alpine:3.19
      script: |
        #!/bin/sh
        set -e
        
        echo "Installing crane..."
        wget -qO- https://github.com/google/go-containerregistry/releases/download/v0.19.0/go-containerregistry_Linux_x86_64.tar.gz | tar xz -C /usr/local/bin crane
        
        echo "Copying busybox image to local registry..."
        crane cp --insecure docker.io/library/busybox:1.36 $(params.APP_IMAGE)
        
        echo "Getting digest..."
        DIGEST=$(crane digest --insecure $(params.APP_IMAGE))
        echo "Digest: $DIGEST"
        
        echo -n "$DIGEST" > $(results.APP_IMAGE_DIGEST.path)
        echo "Fast build completed successfully"
