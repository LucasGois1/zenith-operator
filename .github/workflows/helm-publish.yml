name: Publish Helm Chart

on:
  push:
    branches:
    - main
    paths:
    - 'charts/**'
    - '.github/workflows/helm-publish.yml'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  publish:
    name: Publish Helm Chart to GitHub Pages
    runs-on: ubuntu-latest
    steps:
    - name: Checkout main branch
      uses: actions/checkout@v4
      with:
        ref: main
        fetch-depth: 0

    - name: Install Helm
      uses: azure/setup-helm@v4
      with:
        version: 'latest'

    - name: Lint Helm chart
      run: |
        echo "üîç Linting Helm chart..."
        helm lint charts/zenith-operator
        echo "‚úÖ Chart validation passed"

    - name: Package Helm chart
      run: |
        echo "üì¶ Packaging Helm chart..."
        mkdir -p .helm-publish
        helm package charts/zenith-operator --destination .helm-publish
        echo "‚úÖ Chart packaged successfully"

    - name: Generate Helm repository index
      run: |
        echo "üìù Generating Helm repository index..."
        helm repo index .helm-publish --url https://lucasgois1.github.io/zenith-operator
        echo "‚úÖ Repository index generated"

    - name: Copy Helm artifacts to docs directory
      run: |
        echo "üìã Copying Helm artifacts to docs/..."

        # Ensure docs directory exists
        mkdir -p docs

        # Copy the packaged chart and index.yaml to docs/
        cp .helm-publish/*.tgz docs/
        cp .helm-publish/index.yaml docs/

        # Create .nojekyll to disable Jekyll processing
        touch docs/.nojekyll

        echo "‚úÖ Artifacts copied to docs/"

    - name: Commit and push to main
      run: |
        # Configure git
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"

        # Add only the Helm-related files
        git add docs/*.tgz docs/index.yaml docs/.nojekyll

        # Check if there are changes to commit
        if git diff --staged --quiet; then
          echo "‚ÑπÔ∏è  No changes to commit"
          exit 0
        fi

        # Get chart version from Chart.yaml
        CHART_VERSION=$(grep '^version:' charts/zenith-operator/Chart.yaml | awk '{print $2}')

        # Commit and push
        git commit -m "chore: publish Helm chart v${CHART_VERSION}"
        git push origin main

        echo "‚úÖ Helm chart published to GitHub Pages"

    - name: Summary
      run: |
        CHART_VERSION=$(grep '^version:' charts/zenith-operator/Chart.yaml | awk '{print $2}')
        echo "üéâ Helm chart v${CHART_VERSION} published successfully!"
        echo ""
        echo "üì¶ Chart URL: https://lucasgois1.github.io/zenith-operator/zenith-operator-${CHART_VERSION}.tgz"
        echo "üìã Repository index: https://lucasgois1.github.io/zenith-operator/index.yaml"
        echo ""
        echo "To use this Helm repository:"
        echo "  helm repo add zenith-operator https://lucasgois1.github.io/zenith-operator"
        echo "  helm repo update"
        echo "  helm install my-zenith zenith-operator/zenith-operator"
